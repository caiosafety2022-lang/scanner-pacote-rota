<!DOCTYPE html>
<html lang="pt-br">
<hea
  d>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner 1D ‚Üí Rota (Lotes/Feedback)</title>
  <link rel="preconnect" href="https://unpkg.com"/>
  <style>
    :root{--bg:#0b0f14;--card:#121822;--muted:#93a1b1;--ok:#27ae60;--warn:#e67e22;--err:#e74c3c;--ink:#e6edf3;--accent:#2d9cdb}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0f14,#0f1622);color:var(--ink)}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:22px;margin:0}
    .card{background:var(--card);border:1px solid #1f2836;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid{display:grid;gap:16px}
    @media (min-width:1100px){.grid{grid-template-columns:1.4fr .6fr}}
    label{font-weight:600}
    input[type=file],button,.pill,input[type=text],.num{border-radius:12px;border:1px solid #263248;background:#0c121b;color:var(--ink);padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:var(--accent);border:none;color:white;font-weight:700}
    .pill{display:inline-flex;gap:8px;align-items:center}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .status{border-radius:16px;padding:14px;font-size:18px;font-weight:700;margin-top:8px}
    .ok{background:rgba(39,174,96,.12);border:1px solid rgba(39,174,96,.35)}
    .err{background:rgba(231,76,60,.12);border:1px solid rgba(231,76,60,.35)}
    .warn{background:rgba(230,126,34,.12);border:1px solid rgba(230,126,34,.35)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace;background:#0c121b;border:1px solid #263248;border-radius:8px;padding:2px 6px}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{border-bottom:1px solid #243043;padding:8px 6px;text-align:left}
    .hint{font-size:13px;margin-top:6px;color:var(--muted)}
    .footer{margin-top:24px;font-size:12px;color:var(--muted)}
    .hidden{display:none}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;min-width:280px;max-width:90vw;padding:14px 16px;border-radius:14px;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,.35);z-index:9999}
    .toast.ok{background:rgba(39,174,96,.95);color:white}
    .toast.err{background:rgba(231,76,60,.95);color:white}
    .toast.warn{background:rgba(230,126,34,.95);color:white}
    video{width:100%;max-height:360px;background:#000;border-radius:12px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0c121b;border:1px solid #2a3650;color:#9fb0c8;font-size:12px}
  </style>
  <!-- CSV parser -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Fallback 1D: Quagga2 -->
  <script src="https://unpkg.com/@ericblade/quagga2@2.0.0/dist/quagga.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Scanner 1D ‚Üí Rota (Lotes)</h1>
      <div class="muted">
        CSV fixo (2 colunas): <b>A = ID do pacote</b>, <b>B = ID da rota</b> ‚Äî Code128/39/EAN/UPC/ITF.
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="row">
          <div>
            <label for="csv">Planilha (CSV)</label><br />
            <input id="csv" type="file" accept=".csv,text/csv" />
            <div class="hint">Separador: v√≠rgula. Com ou sem cabe√ßalho.</div>
          </div>
        </div>

        <div class="controls">
          <button id="btn-start" class="primary">Iniciar c√¢mera</button>
          <button id="btn-stop">Parar c√¢mera</button>
          <label class="pill"><input type="checkbox" id="offline-cache"/> Cache offline</label>
          <label class="pill"><input type="checkbox" id="allow-dupes" checked/> Permitir leituras repetidas</label>
          <label class="pill"><input type="checkbox" id="beep" checked/> Beep</label>
          <label class="pill"><input type="checkbox" id="vibrate" checked/> Vibrar</label>
          <label class="pill"><input type="checkbox" id="tts"/> Falar rota</label>
        </div>

        <div id="scan-area" class="card" style="margin-top:12px;padding:8px">
          <video id="video" playsinline muted></video>
        </div>

        <div id="resultado" class="status warn hidden">Aguardando escaneamento‚Ä¶</div>

        <div class="row" style="margin-top:12px">
          <input id="manual" type="text" placeholder="Ou digite/cole um ID de pacote" class="num" />
          <button id="btn-lookup">Buscar rota</button>
          <span id="counter" class="badge">0 lidos</span>
        </div>
      </section>

      <aside class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <strong>Dados carregados</strong>
            <div class="hint">Mostrando at√© 5 exemplos</div>
          </div>
          <div class="muted"><span id="count">0</span> registros</div>
        </div>
        <table class="table" id="preview">
          <thead><tr><th>ID do pacote</th><th>ID da rota</th></tr></thead>
          <tbody></tbody>
        </table>

        <div style="margin-top:16px">
          <strong>Hist√≥rico recente</strong>
          <div class="hint">√öltimos 15 escaneamentos</div>
          <table class="table" id="history">
            <thead><tr><th>Quando</th><th>Pacote</th><th>Rota</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </aside>
    </div>

    <div class="footer">
      Requer HTTPS (GitHub Pages) ou localhost. Verifique permiss√µes no cadeado üîí. Ilumina√ß√£o ajuda muito em 1D.
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    let indexMap = new Map(); // pacote -> rota
    const el = (id)=>document.getElementById(id);
    const resultado = el('resultado');
    const video = el('video');
    let stream = null;
    let usingBarcodeDetector = false;
    let detectLoop = null;
    let quaggaRunning = false;
    let history = [];
    let readCount = 0;
    let lastSeen = new Map(); // code -> timestamp

    function setStatus(msg, type){
      resultado.className = 'status ' + (type||'warn');
      resultado.textContent = msg;
      resultado.classList.remove('hidden');
    }
    function normalize(x){ return String(x||'').trim(); }

    function renderPreview(rows){
      const tbody = document.querySelector('#preview tbody');
      tbody.innerHTML = '';
      rows.slice(0,5).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.pacote}</td><td>${r.rota}</td>`;
        tbody.appendChild(tr);
      });
      el('count').textContent = indexMap.size;
    }

    function renderHistory(){
      const tbody = document.querySelector('#history tbody');
      tbody.innerHTML = '';
      history.slice(-15).reverse().forEach(h=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(h.t).toLocaleTimeString()}</td><td>${h.code}</td><td>${h.rota||'-'}</td><td>${h.ok?'OK':'ERRO'}</td>`;
        tbody.appendChild(tr);
      });
      el('counter').textContent = `${readCount} lidos`;
    }

    function rebuildIndex(data){
      indexMap = new Map();
      const sample = [];
      data.forEach(row=>{
        const p = normalize(row[0]);
        const r = normalize(row[1]);
        if(p){ indexMap.set(p, r||''); if(sample.length<5) sample.push({pacote:p, rota:r}); }
      });
      renderPreview(sample);
      if(el('offline-cache').checked){
        try{ localStorage.setItem('pacote_rota_cache', JSON.stringify({items:[...indexMap.entries()]})); }catch(e){}
      }
    }

    // Feedback helpers
    function beep(){
      if(!el('beep').checked) return;
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='square'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.05); o.stop(); ctx.close(); }, 120);
      }catch(e){}
    }
    function vibrate(){ if(el('vibrate').checked && navigator.vibrate) navigator.vibrate(60); }
    function speak(text){
      if(!el('tts').checked) return;
      try{ const u = new SpeechSynthesisUtterance(text); u.lang='pt-BR'; window.speechSynthesis.speak(u); }catch(e){}
    }
    function toast(msg, type){
      const t = el('toast');
      t.textContent = msg;
      t.className = 'toast ' + (type||'warn');
      t.classList.remove('hidden');
      setTimeout(()=>{ t.classList.add('hidden'); }, 1400);
    }

    function onDetected(codeRaw){
      const code = normalize(codeRaw);
      if(!code) return;
      const now = Date.now();
      const allowDupes = el('allow-dupes').checked;
      const last = lastSeen.get(code) || 0;
      if(!allowDupes && (now - last) < 1200){ return; } // evita repeti√ß√£o do mesmo c√≥digo em ~1.2s
      lastSeen.set(code, now);

      const rota = indexMap.get(code);
      if(rota !== undefined){
        setStatus(`Rota: ${rota}`, 'ok');
        toast(`‚úî Pacote ${code} ‚Üí ${rota}`, 'ok');
        beep(); vibrate(); speak(`Rota ${rota}`);
        history.push({t:now, code, rota, ok:true}); readCount++;
      }else{
        setStatus('C√≥digo n√£o encontrado na planilha.', 'err');
        toast(`‚úñ ${code} n√£o encontrado`, 'err');
        beep();
        history.push({t:now, code, rota:null, ok:false}); readCount++;
      }
      renderHistory();
    }

    function lookupManual(){ onDetected(el('manual').value); }

    // CSV
    el('csv').addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      Papa.parse(file, { complete: (res)=>{
        const data = res.data.filter(r=>r && r.length && r.some(c=>String(c).trim()!==''));
        if(!data.length){ setStatus('CSV vazio.', 'err'); return; }
        const first = data[0];
        const looksLikeHeader = first.some(x => isNaN(Number(String(x).trim())) && String(x).trim().length>0);
        const rows = looksLikeHeader ? data.slice(1) : data;
        rebuildIndex(rows);
        setStatus('Planilha carregada. Pronto para escanear.', 'ok');
      }, error: ()=>setStatus('Falha ao ler o CSV.', 'err') });
    });

    el('btn-lookup').addEventListener('click', lookupManual);
    el('manual').addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') lookupManual(); });

    // Restore cache
    (function(){ try{
      const cached = JSON.parse(localStorage.getItem('pacote_rota_cache')||'null');
      if(cached && cached.items){
        indexMap = new Map(cached.items);
        renderPreview(Array.from(indexMap.entries()).slice(0,5).map(([p,r])=>({pacote:p, rota:r})));
        setStatus('Cache offline carregado. Voc√™ pode escanear mesmo sem enviar CSV agora.', 'ok');
        el('offline-cache').checked = true;
      }
    }catch(e){} })();

    // CAMERA & SCAN (BarcodeDetector -> fallback Quagga)
    async function startWithBarcodeDetector(){
      const supportedFormats = (await window.BarcodeDetector.getSupportedFormats?.()) || [];
      const wanted = ['code_128','code_39','ean_13','ean_8','upc_a','upc_e','itf','codabar'];
      const formats = wanted.filter(f => supportedFormats.includes(f));
      if(!formats.length) throw new Error('BarcodeDetector sem formatos 1D suportados.');

      const detector = new BarcodeDetector({ formats });
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal:'environment' } }, audio:false });
      video.srcObject = stream;
      await video.play();

      usingBarcodeDetector = true;
      const tick = async () => {
        if(!usingBarcodeDetector) return;
        try{
          const barcodes = await detector.detect(video);
          if(barcodes && barcodes.length){
            const val = barcodes[0].rawValue || '';
            if(val){ onDetected(val); }
          }
        }catch(e){ /* ignore */ }
        detectLoop = requestAnimationFrame(tick);
      };
      tick();
      setStatus('C√¢mera ativa (nativo). Escaneie c√≥digos 1D em sequ√™ncia.', 'warn');
    }

    let quaggaCallback = null;
    function startWithQuagga(){
      return new Promise((resolve, reject)=>{
        const config = {
          inputStream : {
            name : 'Live',
            type : 'LiveStream',
            target: document.querySelector('#scan-area'),
            constraints: { facingMode: 'environment', aspectRatio: { min: 1.3, max: 2.5 } }
          },
          locator: { patchSize: 'medium', halfSample: true },
          numOfWorkers: navigator.hardwareConcurrency ? Math.max(1, navigator.hardwareConcurrency - 1) : 2,
          decoder : { readers : ['code_128_reader','code_39_reader','ean_reader','ean_8_reader','upc_reader','upc_e_reader','itf_reader','codabar_reader'] },
          locate: true
        };
        Quagga.init(config, (err)=>{
          if(err){ reject(err); return; }
          Quagga.start();
          quaggaCallback = (result)=>{
            const code = result?.codeResult?.code;
            if(code){ onDetected(code); }
          };
          Quagga.onDetected(quaggaCallback);
          quaggaRunning = true;
          setStatus('C√¢mera ativa (Quagga). Escaneie c√≥digos 1D em sequ√™ncia.', 'warn');
          resolve();
        });
      });
    }

    async function startCamera(){
      try{
        await stopCamera();
        if('BarcodeDetector' in window){
          try { await startWithBarcodeDetector(); return; } catch(e){ /* fallback */ }
        }
        await startWithQuagga();
      }catch(err){
        console.error(err);
        setStatus('Erro ao iniciar c√¢mera. Verifique permiss√µes (cadeado üîí) e tente novamente.', 'err');
      }
    }

    async function stopCamera(){
      try{
        if(detectLoop) cancelAnimationFrame(detectLoop);
        usingBarcodeDetector = false;
        if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
        if(quaggaRunning){
          if(quaggaCallback){ Quagga.offDetected(quaggaCallback); quaggaCallback=null; }
          Quagga.stop(); quaggaRunning=false;
        }
        if(video){ video.pause(); video.srcObject=null; }
        setStatus('C√¢mera parada.', 'warn');
      }catch(e){ /* ignore */ }
    }

    document.getElementById('btn-start').addEventListener('click', startCamera);
    document.getElementById('btn-stop').addEventListener('click', stopCamera);
  </script>
</body>
</html>
