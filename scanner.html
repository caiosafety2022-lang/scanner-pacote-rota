<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner de Pacote → Rota</title>
  <link rel="preconnect" href="https://unpkg.com"/>
  <style>
    :root{--bg:#0b0f14;--card:#121822;--muted:#93a1b1;--ok:#27ae60;--warn:#e67e22;--err:#e74c3c;--ink:#e6edf3;--accent:#2d9cdb}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0f14,#0f1622);color:var(--ink)}
    .wrap{max-width:1000px;margin:0 auto;padding:24px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:22px;margin:0}
    .card{background:var(--card);border:1px solid #1f2836;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid{display:grid;gap:16px}
    @media (min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    label{font-weight:600}
    input[type=file],button,.pill,input[type=text],.num{border-radius:12px;border:1px solid #263248;background:#0c121b;color:var(--ink);padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:var(--accent);border:none;color:white;font-weight:700}
    .pill{display:inline-flex;gap:8px;align-items:center}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .status{border-radius:16px;padding:14px;font-size:18px;font-weight:700;margin-top:8px}
    .ok{background:rgba(39,174,96,.12);border:1px solid rgba(39,174,96,.35)}
    .err{background:rgba(231,76,60,.12);border:1px solid rgba(231,76,60,.35)}
    .warn{background:rgba(230,126,34,.12);border:1px solid rgba(230,126,34,.35)}
    .big{font-size:28px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0c121b;border:1px solid #263248;border-radius:8px;padding:2px 6px}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{border-bottom:1px solid #243043;padding:8px 6px;text-align:left}
    .hint{font-size:13px;margin-top:6px;color:var(--muted)}
    .footer{margin-top:24px;font-size:12px;color:var(--muted)}
    .center{display:flex;align-items:center;justify-content:center}
    .hidden{display:none}
  </style>
  <!-- Libs -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Scanner de Pacote → Rota</h1>
      <div class="muted">Carregue um CSV (2 colunas, <b>fixo</b>): Coluna A = ID do pacote, Coluna B = ID da rota.</div>
    </header>

    <div class="grid">
      <!-- Coluna esquerda: Config e Scanner -->
      <section class="card">
        <div class="row">
          <div>
            <label for="csv">Planilha (CSV)</label><br />
            <input id="csv" type="file" accept=".csv,text/csv" />
            <div class="hint">Formato: "ID do pacote,ID da rota". Com ou sem cabeçalho.</div>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="btn-start" class="primary">Iniciar câmera</button>
          <button id="btn-stop">Parar câmera</button>
          <label class="pill"><input type="checkbox" id="offline-cache"/> Cache offline (carregar tabela no navegador)</label>
        </div>

        <div id="scan-area" class="card" style="margin-top:12px;padding:8px">
          <div id="reader" style="width:100%"></div>
        </div>

        <div id="resultado" class="status warn hidden">Aguardando escaneamento…</div>

        <div class="row" style="margin-top:12px">
          <input id="manual" type="text" placeholder="Ou digite/cole um ID de pacote" class="num" />
          <button id="btn-lookup">Buscar rota</button>
        </div>
      </section>

      <!-- Coluna direita: Dados carregados -->
      <aside class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <strong>Dados carregados</strong>
            <div class="hint">Mostrando até 5 exemplos</div>
          </div>
          <div class="muted"><span id="count">0</span> registros</div>
        </div>
        <table class="table" id="preview">
          <thead>
            <tr><th>ID do pacote</th><th>ID da rota</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="footer">
          Dica: normalizamos espaços (trim). <b>Mapeamento fixo</b>: Coluna A = ID do pacote, Coluna B = ID da rota.
        </div>
      </aside>
    </div>

    <div class="footer">
      Compatível com QR e códigos de barras mais comuns (via <span class="kbd">html5-qrcode</span>). Para códigos 1D específicos não suportados, adapte o leitor.
    </div>
  </div>

  <script>
    // Estado
    let indexMap = new Map(); // pacote -> rota
    let scanner = null; // Html5QrcodeScanner
    let currentCameraRunning = false;

    const el = (id)=>document.getElementById(id);
    const resultado = el('resultado');

    function normalize(x){
      return String(x || '').trim();
    }

    function setStatus(msg, type){
      resultado.classList.remove('hidden','ok','err','warn');
      resultado.classList.add(type||'warn');
      resultado.textContent = msg;
    }

    function renderPreview(rows){
      const tbody = document.querySelector('#preview tbody');
      tbody.innerHTML = '';
      rows.slice(0,5).forEach(r=>{
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        const td2 = document.createElement('td');
        td1.textContent = r.pacote;
        td2.textContent = r.rota;
        tr.appendChild(td1); tr.appendChild(td2);
        tbody.appendChild(tr);
      });
      el('count').textContent = indexMap.size;
    }

    function rebuildIndex(data){
      indexMap = new Map();
      const sample
